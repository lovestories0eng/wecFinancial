!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}((function(e){"use strict";e.TernServer=function(i){var a=this;this.options=i||{};var c=this.options.plugins||(this.options.plugins={});c.doc_comment||(c.doc_comment=!0),this.options.useWorker?this.server=new b(this):this.server=new tern.Server({getFile:function(e,t){return o(a,e,t)},async:!0,defs:this.options.defs||[],plugins:c}),this.docs=Object.create(null),this.trackChange=function(e,t){!function(e,t,n){var o=r(e,t),i=e.cachedArgHints;i&&i.doc==t&&p(i.start,n.to)<=0&&(e.cachedArgHints=null);var a=o.changed;null==a&&(o.changed=a={from:n.from.line,to:n.from.line});var c=n.from.line+(n.text.length-1);n.from.line<a.to&&(a.to=a.to-(n.to.line-c)),c>=a.to&&(a.to=c+1),a.from>n.from.line&&(a.from=n.from.line),t.lineCount()>250&&n.to-a.from>100&&setTimeout((function(){o.changed&&o.changed.to-o.changed.from>100&&s(e,o)}),200)}(a,e,t)},this.cachedArgHints=null,this.activeArgHints=null,this.jumpStack=[],this.getHint=function(o,r){return function(o,r,i){o.request(r,{type:"completions",types:!0,docs:!0,urls:!0},(function(s,a){if(s)return C(o,r,s);var c,l,u=[],f="",d=a.start,p=a.end;'["'==r.getRange(t(d.line,d.ch-2),d)&&'"]'!=r.getRange(p,t(p.line,p.ch+2))&&(f='"]');for(var h=0;h<a.completions.length;++h){var g=a.completions[h],m=(c=g.type,l=void 0,l="?"==c?"unknown":"number"==c||"string"==c||"bool"==c?c:/^fn\(/.test(c)?"fn":/^\[/.test(c)?"array":"object",n+"completion "+n+"completion-"+l);a.guess&&(m+=" "+n+"guess"),u.push({text:g.name+f,displayText:g.name,className:m,data:g})}var x={from:d,to:p,list:u},w=null;e.on(x,"close",(function(){y(w)})),e.on(x,"update",(function(){y(w)})),e.on(x,"select",(function(e,t){y(w);var r=o.options.completionTip?o.options.completionTip(e.data):e.data.doc;r&&((w=v(t.parentNode.getBoundingClientRect().right+window.pageXOffset,t.getBoundingClientRect().top+window.pageYOffset,r)).className+=" "+n+"hint-doc")})),i(x)}))}(a,o,r)},this.getHint.async=!0},e.TernServer.prototype={addDoc:function(t,n){var o={doc:n,name:t,changed:null};return this.server.addFile(t,w(this,o)),e.on(n,"change",this.trackChange),this.docs[t]=o},delDoc:function(t){var n=i(this,t);n&&(e.off(n.doc,"change",this.trackChange),delete this.docs[n.name],this.server.delFile(n.name))},hideDoc:function(e){x(this);var t=i(this,e);t&&t.changed&&s(this,t)},complete:function(e){e.showHint({hint:this.getHint})},showType:function(e,t,n){a(this,e,t,"type",n)},showDocs:function(e,t,n){a(this,e,t,"documentation",n)},updateArgHints:function(n){!function(n,o){if(x(n),!o.somethingSelected()){var r=o.getTokenAt(o.getCursor()).state,i=e.innerMode(o.getMode(),r);if("javascript"==i.mode.name){var s=i.state.lexical;if("call"==s.info){for(var a,u=s.pos||0,f=o.getOption("tabSize"),d=o.getCursor().line,h=Math.max(0,d-9),g=!1;d>=h;--d){for(var m=o.getLine(d),v=0,y=0;;){var C=m.indexOf("\t",y);if(-1==C)break;v+=f-(C+v)%f-1,y=C+1}if(a=s.column-v,"("==m.charAt(a)){g=!0;break}}if(g){var w=t(d,a),b=n.cachedArgHints;if(b&&b.doc==o.getDoc()&&0==p(w,b.start))return c(n,o,u);n.request(o,{type:"type",preferFunction:!0,end:w},(function(e,t){!e&&t.type&&/^fn\(/.test(t.type)&&(n.cachedArgHints={start:y,type:l(t.type),name:t.exprName||t.name||"fn",guess:t.guess,doc:o.getDoc()},c(n,o,u))}))}}}}}(this,n)},jumpToDef:function(e){!function(e,n){function o(o){var i={type:"definition",variable:o||null},s=r(e,n.getDoc());e.server.request(d(e,s,i),(function(o,r){if(o)return C(e,n,o);if(r.file||!r.url){if(r.file){var i,a=e.docs[r.file];if(a&&(i=function(e,n){for(var o=n.context.slice(0,n.contextOffset).split("\n"),r=n.start.line-(o.length-1),i=t(r,(1==o.length?n.start.ch:e.getLine(r).length)-o[0].length),s=e.getLine(r).slice(i.ch),a=r+1;a<e.lineCount()&&s.length<n.context.length;++a)s+="\n"+e.getLine(a);if(s.slice(0,n.context.length)==n.context)return n;for(var c,l=e.getSearchCursor(n.context,0,!1),u=1/0;l.findNext();){var f=l.from(),d=1e4*Math.abs(f.line-i.line);d||(d=Math.abs(f.ch-i.ch)),d<u&&(c=f,u=d)}if(!c)return null;if(1==o.length?c.ch+=o[0].length:c=t(c.line+(o.length-1),o[o.length-1].length),n.start.line==n.end.line)var p=t(c.line,c.ch+(n.end.ch-n.start.ch));else p=t(c.line+(n.end.line-n.start.line),n.end.ch);return{start:c,end:p}}(a.doc,r)))return e.jumpStack.push({file:s.name,start:n.getCursor("from"),end:n.getCursor("to")}),void u(e,s,a,i.start,i.end)}C(e,n,"Could not find a definition.")}else window.open(r.url)}))}!function(e){var t=e.getCursor("end"),n=e.getTokenAt(t);return(!(n.start<t.ch)||"comment"!=n.type&&"string"!=n.type)&&/\w/.test(e.getLine(t.line).slice(Math.max(t.ch-1,0),t.ch+1))}(n)?g(n,"Jump to variable",(function(e){e&&o(e)})):o()}(this,e)},jumpBack:function(e){!function(e,t){var n=e.jumpStack.pop(),o=n&&e.docs[n.file];o&&u(e,r(e,t.getDoc()),o,n.start,n.end)}(this,e)},rename:function(e){!function(e,t){var n=t.getTokenAt(t.getCursor());if(!/\w/.test(n.string))return C(e,t,"Not at a variable");g(t,"New name for "+n.string,(function(n){e.request(t,{type:"rename",newName:n,fullDocs:!0},(function(n,o){if(n)return C(e,t,n);!function(e,t){for(var n=Object.create(null),o=0;o<t.length;++o)(n[(c=t[o]).file]||(n[c.file]=[])).push(c);for(var r in n){var i=e.docs[r],s=n[r];if(i){s.sort((function(e,t){return p(t.start,e.start)}));var a="*rename"+ ++f;for(o=0;o<s.length;++o){var c=s[o];i.doc.replaceRange(c.text,c.start,c.end,a)}}}}(e,o.changes)}))}))}(this,e)},selectName:function(e){!function(e,t){var n=r(e,t.doc).name;e.request(t,{type:"refs"},(function(o,r){if(o)return C(e,t,o);for(var i=[],s=0,a=0;a<r.refs.length;a++){var c=r.refs[a];c.file==n&&(i.push({anchor:c.start,head:c.end}),p(s,c.start)>=0&&p(s,c.end)<=0&&(s=i.length-1))}t.setSelections(i,s)}))}(this,e)},request:function(e,t,n,o){var i=this,s=r(this,e.getDoc()),a=d(this,s,t,o);this.server.request(a,(function(e,o){!e&&i.options.responseFilter&&(o=i.options.responseFilter(s,t,a,e,o)),n(e,o)}))},destroy:function(){this.worker&&(this.worker.terminate(),this.worker=null)}};var t=e.Pos,n="CodeMirror-Tern-";function o(e,t,n){var o=e.docs[t];o?n(w(e,o)):e.options.getFile?e.options.getFile(t,n):n(null)}function r(e,t,n){for(var o in e.docs){var r=e.docs[o];if(r.doc==t)return r}if(!n)for(var i=0;;++i)if(o="[doc"+(i||"")+"]",!e.docs[o]){n=o;break}return e.addDoc(n,t)}function i(t,n){return"string"==typeof n?t.docs[n]:(n instanceof e&&(n=n.getDoc()),n instanceof e.Doc?r(t,n):void 0)}function s(e,t){e.server.request({files:[{type:"full",name:t.name,text:w(e,t)}]},(function(e){e?window.console.error(e):t.changed=null}))}function a(e,t,n,o,r){e.request(t,o,(function(n,o){if(n)return C(e,t,n);if(e.options.typeTip)var i=e.options.typeTip(o);else if(i=h("span",null,h("strong",null,o.type||"not found")),o.doc&&i.appendChild(document.createTextNode(" — "+o.doc)),o.url){i.appendChild(document.createTextNode(" "));var s=i.appendChild(h("a",null,"[docs]"));s.href=o.url,s.target="_blank"}m(t,i),r&&r()}),n)}function c(e,t,o){x(e);for(var r=e.cachedArgHints,i=r.type,s=h("span",r.guess?n+"fhint-guess":null,h("span",n+"fname",r.name),"("),a=0;a<i.args.length;++a){a&&s.appendChild(document.createTextNode(", "));var c=i.args[a];s.appendChild(h("span",n+"farg"+(a==o?" "+n+"farg-current":""),c.name||"?")),"?"!=c.type&&(s.appendChild(document.createTextNode(": ")),s.appendChild(h("span",n+"type",c.type)))}s.appendChild(document.createTextNode(i.rettype?") -> ":")")),i.rettype&&s.appendChild(h("span",n+"type",i.rettype));var l=t.cursorCoords(null,"page");e.activeArgHints=v(l.right+1,l.bottom,s)}function l(e){var t=[],n=3;function o(t){for(var o=0,r=n;;){var i=e.charAt(n);if(t.test(i)&&!o)return e.slice(r,n);/[{\[\(]/.test(i)?++o:/[}\]\)]/.test(i)&&--o,++n}}if(")"!=e.charAt(n))for(;;){var r=e.slice(n).match(/^([^, \(\[\{]+): /);if(r&&(n+=r[0].length,r=r[1]),t.push({name:r,type:o(/[\),]/)}),")"==e.charAt(n))break;n+=2}var i=e.slice(n).match(/^\) -> (.*)$/);return{args:t,rettype:i&&i[1]}}function u(e,t,n,o,r){n.doc.setSelection(o,r),t!=n&&e.options.switchToDoc&&(x(e),e.options.switchToDoc(n.name,n.doc))}var f=0;function d(n,o,r,i){var s=[],a=0,c=!r.fullDocs;c||delete r.fullDocs,"string"==typeof r&&(r={type:r}),r.lineCharPositions=!0,null==r.end&&(r.end=i||o.doc.getCursor("end"),o.doc.somethingSelected()&&(r.start=o.doc.getCursor("start")));var l=r.start||r.end;for(var u in o.changed?o.doc.lineCount()>250&&!1!==c&&o.changed.to-o.changed.from<100&&o.changed.from<=l.line&&o.changed.to>r.end.line?(s.push(function(n,o,r){for(var i,s=n.doc,a=null,c=null,l=o.line-1,u=Math.max(0,l-50);l>=u;--l){var f=s.getLine(l);if(!(f.search(/\bfunction\b/)<0)){var d=e.countColumn(f,null,4);null!=a&&a<=d||(a=d,c=l)}}null==c&&(c=u);var p=Math.min(s.lastLine(),r.line+20);if(null==a||a==e.countColumn(s.getLine(o.line),null,4))i=p;else for(i=r.line+1;i<p&&!((d=e.countColumn(s.getLine(i),null,4))<=a);++i);var h=t(c,0);return{type:"part",name:n.name,offsetLines:h.line,text:s.getRange(h,t(i,0))}}(o,l,r.end)),r.file="#0",a=s[0].offsetLines,null!=r.start&&(r.start=t(r.start.line- -a,r.start.ch)),r.end=t(r.end.line-a,r.end.ch)):(s.push({type:"full",name:o.name,text:w(n,o)}),r.file=o.name,o.changed=null):r.file=o.name,n.docs){var f=n.docs[u];f.changed&&f!=o&&(s.push({type:"full",name:f.name,text:w(n,f)}),f.changed=null)}return{query:r,files:s}}var p=e.cmpPos;function h(e,t){var n=document.createElement(e);t&&(n.className=t);for(var o=2;o<arguments.length;++o){var r=arguments[o];"string"==typeof r&&(r=document.createTextNode(r)),n.appendChild(r)}return n}function g(e,t,n){e.openDialog?e.openDialog(t+": <input type=text>",n):n(prompt(t,""))}function m(t,n){t.state.ternTooltip&&y(t.state.ternTooltip);var o=t.cursorCoords(),r=t.state.ternTooltip=v(o.right+1,o.bottom,n);function i(){var e;t.state.ternTooltip=null,r.parentNode&&(t.off("cursorActivity",i),t.off("blur",i),t.off("scroll",i),(e=r).style.opacity="0",setTimeout((function(){y(e)}),1100))}var s=!1,a=!1;e.on(r,"mousemove",(function(){s=!0})),e.on(r,"mouseout",(function(t){e.contains(r,t.relatedTarget||t.toElement)||(a?i():s=!1)})),setTimeout((function(){a=!0,s||i()}),1700),t.on("cursorActivity",i),t.on("blur",i),t.on("scroll",i)}function v(e,t,o){var r=h("div",n+"tooltip",o);return r.style.left=e+"px",r.style.top=t+"px",document.body.appendChild(r),r}function y(e){var t=e&&e.parentNode;t&&t.removeChild(e)}function C(e,t,n){e.options.showError?e.options.showError(t,n):m(t,String(n))}function x(e){e.activeArgHints&&(y(e.activeArgHints),e.activeArgHints=null)}function w(e,t){var n=t.doc.getValue();return e.options.fileFilter&&(n=e.options.fileFilter(n,t.name,t.doc)),n}function b(e){var t=e.worker=new Worker(e.options.workerScript);t.postMessage({type:"init",defs:e.options.defs,plugins:e.options.plugins,scripts:e.options.workerDeps});var n=0,r={};function i(e,o){o&&(e.id=++n,r[n]=o),t.postMessage(e)}t.onmessage=function(t){var n=t.data;"getFile"==n.type?o(e,n.name,(function(e,t){i({type:"getFile",err:String(e),text:t,id:n.id})})):"debug"==n.type?window.console.log(n.message):n.id&&r[n.id]&&(r[n.id](n.err,n.body),delete r[n.id])},t.onerror=function(e){for(var t in r)r[t](e);r={}},this.addFile=function(e,t){i({type:"add",name:e,text:t})},this.delFile=function(e){i({type:"del",name:e})},this.request=function(e,t){i({type:"req",body:e},t)}}}));